<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoraggio UPS - NUT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        
        h2 { border-bottom: 2px solid #333; padding-bottom: 5px; }
        .error { color: white; background-color: #c0392b; padding: 10px; border-radius: 5px; font-weight: bold; }
        .warning { color: black; background-color: #f39c12; padding: 5px; border-radius: 3px; }
        .critical { color: red; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }

        /* Nuovo contenitore per affiancare gli UPS */
        .ups-grid-container {
            display: flex;         
            flex-wrap: wrap;       
            gap: 20px;             
            margin-top: 20px;
        }

        /* Regola per le singole schede UPS */
        .ups-box {
            flex: 1 1 45%; 
            min-width: 300px; 
            border: 1px solid #ccc; 
            padding: 15px; 
            background-color: white; 
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* Stile specifico per i Canvas */
        .chart-container {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        /* Rimuovo la classe height: 550px dal CSS per usare la classe Tailwind h-[550px] direttamente nell'HTML */
        .chart-main-container {
            min-height: 0;
        }

    </style>
    <!-- Inclusione della libreria Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 1. Definizione della variabile globale per passare i dati JSON a JavaScript -->
    <script>
        // CORREZIONE per SyntaxError: Utilizziamo un approccio più robusto con JSON.parse.
        // Il filtro 'tojson | safe' assicura che il contenuto sia una stringa JSON valida.
        const allUpsDataString = '{{ data | default({}) | tojson | safe }}';
        const allUpsData = JSON.parse(allUpsDataString);
        
        // Dichiarazione della funzione updateChartPeriod (definita in chart.js) per l'uso inline nell'HTML
        function updateChartPeriod(upsName, period) {
            // Sarà riempita da chart.js
        }
    </script>

    <!-- 2. Inclusione del tuo file JS (usando url_for per il percorso corretto) -->
    <script src="{{ url_for('static', filename='chart.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
</head>
<body>

    <!-- AGGIORNAMENTO: Aggiunto il logo e il testo completo nel titolo H1 -->
    <h1 class="text-3xl font-bold mb-6">
        <img src="/static/images/logo_ara.png" alt="Logo Ara" class="h-10 inline-block align-middle mr-3" onerror="this.onerror=null; this.src='https://placehold.co/40x40/007bff/ffffff?text=LOGO';" />
        ⚡ Stato Monitoraggio UPS (via NUT) Osservatorio virginio Cesarini
    </h1>

    <!-- INIZIO BLOCCO LOGICA GENERALE -->
    {% if 'error' in data %}
        <!-- MESSAGGIO DI ERRORE DI CONNESSIONE -->
        <div class="error">
            <h3>ERRORE DI CONNESSIONE A NUT</h3>
            <p>{{ data['error'] }}</p>
            <p>Verifica che il demone NUT (upsd) sia in esecuzione su **{{ NUT_HOST }}** sulla porta **{{ NUT_PORT }}**.</p>
        </div>
    
    {% else %}
    
        <!-- CONTENUTO PRINCIPALE DELLA DASHBOARD -->
        
        <p>
            <!-- 4. LOGICA CORRETTA PER IL DETTAGLIO: usa la variabile 'detail' -->
            {% if detail == 'full' %}
                <a href="/">Visualizza Dettagli Standard</a>
            {% else %}
                <a href="/?dettaglio=full">Visualizza Dettagli Completi</a>
            {% endif %}
        </p>

        <div class="ups-grid-container">
            
            <!-- CICLO PRINCIPALE SUGLI UPS -->
            {% for ups_name, ups_info in data.items() %}
                <div class="ups-box">
                    <!-- 3. CORREZIONE: Stile del nome dell'UPS (UPS Name è la variabile ups_name) -->
                    <h2>UPS {{ ups_info.rooms }} : <span style="font-weight: bold; color: #007bff;">{{ ups_name }}</span></h2>
                    
                    <p>Ultimo Aggiornamento: {{ ups_info.last_update }}</p>

                    <h3>Stato Corrente (Flags)</h3>
                    {% set status_text = ups_info.vars['ups.status'] | default('Sconosciuto') | replace(' ', ', ') %}
                    
                    {% if 'OB' in status_text or 'LOWBATT' in status_text %}
                        <p class="critical">Stato: {{ status_text }}</p>
                        
                        {% if 'OB' in status_text %}
                            <p class="warning">ATTENZIONE: UPS sta funzionando a batteria (On Battery - OB)!</p>
                        {% endif %}
                        
                    {% else %}
                        <p>Stato: {{ status_text }}</p>
                    {% endif %}
                    <small>(OL = Online, OB = On Battery, LB = Low Battery)</small>
                    
                    <h3>Dettagli Tecnici</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Variabile</th>
                                <th>Valore</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set vars_to_show = ['input.voltage', 'battery.charge', 'battery.runtime', 'ups.load', 'ups.temperature'] %}
                            
                            {% for var_name, var_value in ups_info.vars.items() %}
                                {% if detail == 'full' or var_name in vars_to_show %}
                                <tr>
                                    <td>{{ var_name }}</td>
                                    <td>{{ var_value }}</td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <div class="chart-container">
                        
                        <!-- SELETTORE PERIODI -->
                        <div id="{{ ups_name }}-period-buttons" class="w-full flex justify-center space-x-2 p-2 bg-gray-100 rounded-lg shadow-inner mb-4">
                            <button data-period="1d" onclick="updateChartPeriod('{{ ups_name }}', '1d')" 
                                    class="px-3 py-1 text-sm rounded-lg bg-blue-600 text-white transition duration-150">
                                24 Ore
                            </button>
                            <button data-period="1w" onclick="updateChartPeriod('{{ ups_name }}', '1w')" 
                                    class="px-3 py-1 text-sm rounded-lg bg-white text-gray-700 hover:bg-blue-500 hover:text-white transition duration-150">
                                1 Settimana
                            </button>
                            <button data-period="1m" onclick="updateChartPeriod('{{ ups_name }}', '1m')" 
                                    class="px-3 py-1 text-sm rounded-lg bg-white text-gray-700 hover:bg-blue-500 hover:text-white transition duration-150">
                                1 Mese
                            </button>
                        </div>
                        
                        <!-- Contenitore principale dei grafici: Altezza fissa di 550px -->
                        <!-- Rimosso overflow-y-hidden e chart-main-container per usare h-[550px] direttamente -->
                        <div class="flex flex-col lg:flex-row gap-4 mb-8 h-[350px]" id="{{ ups_name }}-charts-container">
                            
                            <!-- Contenitore del Grafico Tensione: Deve avere h-full (height: 100%) per ereditare 550px -->
                            <div class="w-full lg:w-1/2 p-4 bg-white shadow-xl rounded-lg h-full flex flex-col">
                                <h4 class="text-lg font-semibold text-gray-700 mb-3">Storico Tensione</h4>
                                <!-- WRAPPER: Prende lo spazio con flex-grow e imposta la posizione relativa -->
                                <div class="relative flex-grow">
                                    <!-- Canvas: 100% di larghezza e altezza del wrapper -->
                                    <canvas id="chart-voltage-{{ ups_name }}" class="w-full h-full"></canvas>
                                </div>
                            </div>
                            
                            <!-- Contenitore del Grafico Batteria: Deve avere h-full (height: 100%) per ereditare 550px -->
                            <div class="w-full lg:w-1/2 p-4 bg-white shadow-xl rounded-lg h-full flex flex-col">
                                <h4 class="text-lg font-semibold text-gray-700 mb-3">Storico Batteria</h4>
                                <!-- WRAPPER: Prende lo spazio con flex-grow e imposta la posizione relativa -->
                                <div class="relative flex-grow">
                                    <!-- Canvas: 100% di larghezza e altezza del wrapper -->
                                    <canvas id="chart-charge-{{ ups_name }}" class="w-full h-full"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>    

                </div> <!-- Chiusura di ups-box -->
            {% endfor %}
        </div> <!-- Chiusura di ups-grid-container -->
        
    {% endif %}

</body>
</html>
